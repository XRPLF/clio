name: Build Clio
on:
  push:
    branches:  [master, release/*, develop, develop-next]
  pull_request:
    branches:  [master, release/*, develop, develop-next]
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Run clang-format
        uses: ./.github/actions/lint

  build_clio:
    name: Build Clio
    runs-on: [self-hosted, Linux]
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        type:
          - suffix: deb
            image: rippleci/clio-dpkg-builder:2022-09-17
            script: dpkg
          - suffix: rpm
            image: rippleci/clio-rpm-builder:2022-09-17
            script: rpm

    container:
      image: ${{ matrix.type.image }}
      # options: --user 1001
    steps:
      - uses: actions/checkout@v3
        with:
          path: clio
          fetch-depth: 0

      - name: Clone Clio packaging repo
        uses: actions/checkout@v3
        with:
          path: clio-packages
          repository: XRPLF/clio-packages
          ref: main

      - name: Build
        shell: bash
        run: |
          export CLIO_ROOT=$(realpath clio)
          if [ ${{ matrix.type.suffix }} == "rpm" ]; then
            source /opt/rh/devtoolset-11/enable
          fi
          cmake -S clio-packages -B clio-packages/build -DCLIO_ROOT=$CLIO_ROOT -DCODE_COVERAGE=on
          cmake --build clio-packages/build --parallel $(nproc)
          
          cp ./clio-packages/build/clio-prefix/src/clio-build/clio_tests .
          mv ./clio-packages/build/*.${{ matrix.type.suffix }} .
          cd ./clio-packages/build/clio-prefix/src/clio-build

      - name: Build
        shell: bash
        run: |
            export CLIO_ROOT=$(realpath clio)
            pip3 install gcovr
            rm -rf ./coverage
            mkdir ./coverage
            python3 -m gcovr --html --html-details -r $CLIO_ROOT --object-directory=. -o ./coverage/clover.xml

      - name: Run tests
        timeout-minutes: 10
        uses: ./.github/actions/test
      
      - name: coverage
        uses: danhunsaker/clover-reporter-action@v0.2.17-clover
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          clover-file: ./coverage/clover.xml
    

      - name: Artifact packages
        uses: actions/upload-artifact@v3
        with:
          name: clio_${{ matrix.type.suffix }}_packages
          path: ${{ github.workspace }}/*.${{ matrix.type.suffix }}

      - name: Artifact clio_tests
        uses: actions/upload-artifact@v3
        with:
          name: clio_tests-${{ matrix.type.suffix }}
          path: ${{ github.workspace }}/clio_tests


  test_clio:
    name: Test Clio
    runs-on: [self-hosted, Linux]
    needs: build_clio
    strategy:
      fail-fast: false
      matrix:
        suffix: [rpm, deb]
    steps:
      - uses: actions/checkout@v3

      - name: Get clio_tests artifact
        uses: actions/download-artifact@v3
        with:
          name: clio_tests-${{ matrix.suffix }}

      - name: Run tests
        timeout-minutes: 10
        uses: ./.github/actions/test
